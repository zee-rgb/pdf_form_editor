<%# PDF Editor with Rails Forms - Turbo implementation %>
<% content_for :full_width, true %>

<div class="min-h-screen bg-gray-100">
  <!-- Top toolbar -->
  <div class="bg-white border-b p-4 flex items-center gap-3 sticky top-0 z-50">
    <div class="flex items-center gap-3 flex-1 min-w-0 overflow-hidden">
      <h1 class="text-xl font-bold truncate"><%= @pdf_document.title %></h1>
    </div>
    <div class="flex gap-3 shrink-0 ml-auto whitespace-nowrap">
      <%= link_to "Download PDF", download_pdf_document_path(@pdf_document), class: "btn btn-primary text-white" %>
      <%= link_to "← Back to PDFs", pdf_documents_path, class: "btn" %>
    </div>
  </div>

  <!-- Status messages -->
  <%= turbo_frame_tag "status_messages" do %>
    <% if notice %>
      <div class="max-w-lg mx-auto mt-4 p-3 rounded bg-green-500 text-white">
        <%= notice %>
      </div>
    <% end %>
    <% if alert %>
      <div class="max-w-lg mx-auto mt-4 p-3 rounded bg-red-500 text-white">
        <%= alert %>
      </div>
    <% end %>
  <% end %>

  <!-- Two-column layout -->
  <div class="flex w-full">
    <!-- Left sidebar - Tools -->
    <aside class="w-80 shrink-0 bg-white border-r p-4 space-y-6">
      <!-- Add Text Form -->
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-3">Add Text</h3>
        <%= turbo_frame_tag "text_form" do %>
          <%= form_with url: add_text_pdf_document_path(@pdf_document), method: :post do |form| %>
            <div class="space-y-3">
              <%= form.label :content, "Text to add", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field :content, placeholder: "Enter text...", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
              
              <div class="border rounded-md p-3 bg-gray-50">
                <p class="text-sm text-gray-600 mb-2">Click on PDF where you want to place text:</p>
                <div id="pdf-coordinates" class="flex gap-2">
                  <div class="flex-1">
                    <%= form.label :x, "X (%)", class: "block text-xs text-gray-500" %>
                    <%= form.number_field :x, step: 0.1, class: "w-full px-2 py-1 text-sm border rounded" %>
                  </div>
                  <div class="flex-1">
                    <%= form.label :y, "Y (%)", class: "block text-xs text-gray-500" %>
                    <%= form.number_field :y, step: 0.1, class: "w-full px-2 py-1 text-sm border rounded" %>
                  </div>
                </div>
              </div>
              
              <%= form.submit "Add Text", class: "w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700" %>
            </div>
          <% end %>
        <% end %>
      </div>

      <!-- Add Signature -->
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-3">Add Signature</h3>
        <%= turbo_frame_tag "signature_form" do %>
          <%= form_with url: add_signature_pdf_document_path(@pdf_document), method: :post do |form| %>
            <div class="space-y-3">
              <%= form.label :content, "Signature", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field :content, placeholder: "Type your name...", class: "w-full px-3 py-2 border rounded-md" %>
              
              <%= form.label :font, "Font style", class: "block text-sm font-medium text-gray-700 mt-3" %>
              <%= form.select :font, 
                  [["Dancing Script", "Dancing Script"], 
                   ["Great Vibes", "Great Vibes"], 
                   ["Allura", "Allura"]], 
                  {}, { class: "w-full px-3 py-2 border rounded-md" } %>
              
              <div class="border rounded-md p-3 bg-gray-50">
                <p class="text-sm text-gray-600 mb-2">Position:</p>
                <div class="flex gap-2">
                  <div class="flex-1">
                    <%= form.label :x, "X (%)", class: "block text-xs text-gray-500" %>
                    <%= form.number_field :x, step: 0.1, class: "w-full px-2 py-1 text-sm border rounded" %>
                  </div>
                  <div class="flex-1">
                    <%= form.label :y, "Y (%)", class: "block text-xs text-gray-500" %>
                    <%= form.number_field :y, step: 0.1, class: "w-full px-2 py-1 text-sm border rounded" %>
                  </div>
                </div>
              </div>
              
              <%= form.submit "Add Signature", class: "w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700" %>
            </div>
          <% end %>
        <% end %>
      </div>
    </aside>

    <!-- Right side - PDF Viewer -->
    <div class="flex-1 bg-gray-100 relative overflow-auto">
      <div class="p-4">
        <!-- PDF Container with Interactive Overlay -->
        <div id="pdf-container" class="relative bg-white shadow-lg rounded-lg overflow-hidden">
          <!-- PDF Viewer - using simple embed tag for better browser compatibility -->
          <% if @pdf_document.pdf_file.attached? %>
            <embed src="<%= url_for(@pdf_document.pdf_file) %>" 
                   type="application/pdf"
                   width="100%" 
                   height="800px"
                   class="w-full">
                   
            <!-- Interactive Click Overlay for Coordinates -->
            <button id="click-overlay" class="absolute inset-0 cursor-crosshair border-0 p-0 m-0" 
                 onclick="handlePdfClick(event)" 
                 onkeydown="handlePdfKeyNav(event)"
                 aria-label="Click on PDF to place elements"
                 style="background: transparent; outline: none;">
              
              <!-- Existing elements display -->
              <%= turbo_frame_tag "overlay_elements" do %>
                <% if @pdf_document.overlay_elements.present? %>
                  <% @pdf_document.overlay_elements.each_with_index do |element, index| %>
                    <div class="absolute text-xs bg-white/90 px-1 py-0.5 rounded shadow-sm border"
                         style="left: <%= element['x'] %>%; top: <%= element['y'] %>%; min-width: 60px; min-height: 20px;">
                      <%= element['content'] %>
                      <%= link_to "×", remove_element_pdf_document_path(@pdf_document, index: index), 
                          method: :delete,
                          class: "absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3 h-3 text-xs hover:bg-red-600 flex items-center justify-center",
                          style: "font-size: 8px;" %>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          <% else %>
            <div class="flex items-center justify-center h-64 text-gray-500">
              No PDF attached
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Simplified minimal JavaScript just for coordinate selection
  function handlePdfClick(event) {
    const rect = event.currentTarget.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;
    
    // Set values in both form fields
    document.querySelectorAll('input[name="x"]').forEach(input => {
      input.value = x.toFixed(1);
    });
    
    document.querySelectorAll('input[name="y"]').forEach(input => {
      input.value = y.toFixed(1);
    });
  }
  
  // Basic keyboard navigation support
  function handlePdfKeyNav(event) {
    if (event.key === "Enter") {
      // Process center click on Enter
      const overlay = event.currentTarget;
      const rect = overlay.getBoundingClientRect();
      const centerX = rect.left + (rect.width / 2);
      const centerY = rect.top + (rect.height / 2);
      
      const syntheticEvent = {
        currentTarget: overlay,
        clientX: centerX,
        clientY: centerY
      };
      
      handlePdfClick(syntheticEvent);
    }
  }
</script>
